# Спецификация формата кинематического дерева

## Обзор

Формат представляет иерархическое дерево трансформаций (кинематическую цепь), где каждый узел может быть статическим звеном или подвижным сочленением (вращательным или линейным).

## Структура узла (JSON)

```json
{
  "name": "string",
  "type": "transform" | "rotator" | "actuator",
  "pose": {
    "position": [x, y, z],
    "orientation": [qx, qy, qz, qw]
  },
  "axis": [ax, ay, az],
  "model": { ... },
  "children": [ ... ]
}
```

## Поля

### `name` (string)
Уникальное имя узла в дереве. Используется для идентификации сочленений при обновлении координат.

### `type` (string)
Тип трансформации:

| Значение | Описание |
|----------|----------|
| `"transform"` | Статическое звено (фиксированная поза) |
| `"rotator"` | Вращательное сочленение (1 DOF, вращение вокруг оси) |
| `"actuator"` | Линейное сочленение (1 DOF, перемещение вдоль оси) |

### `pose` (object)
Локальная поза относительно родителя:
- `position`: `[x, y, z]` — смещение (float)
- `orientation`: `[qx, qy, qz, qw]` — кватернион ориентации (x, y, z, w)

**Примечание:** Единицы измерения пока не согласованы.

### `axis` (array, опционально)
Только для `rotator` и `actuator`. Вектор оси движения:
- `[ax, ay, az]` — единичный вектор направления оси

Для `rotator`: ось вращения.
Для `actuator`: направление линейного перемещения.

### `model` (object)
Геометрия визуализации узла:

```json
// Куб
{ "type": "cube", "size": [width, height, depth] }

// Сфера
{ "type": "sphere", "radius": number }

// Цилиндр
{ "type": "cylinder", "radius": number, "height": number }

// Конус (усечённый)
{ "type": "cone", "radius1": number, "radius2": number, "height": number }

// Внешний файл
{ "type": "file", "path": "relative/path/to/model.obj" }
```

**TODO:** Решить вопрос с форматом 3D-моделей для веб-стороны (OBJ, glTF, и т.д.)

### `children` (array)
Список дочерних узлов (рекурсивная структура).

---

## Пример дерева

```json
{
  "name": "base",
  "type": "transform",
  "pose": {
    "position": [0, 0, 0],
    "orientation": [0, 0, 0, 1]
  },
  "model": { "type": "cube", "size": [100, 100, 50] },
  "children": [
    {
      "name": "joint1",
      "type": "rotator",
      "pose": {
        "position": [0, 0, 50],
        "orientation": [0, 0, 0, 1]
      },
      "axis": [0, 0, 1],
      "model": { "type": "cylinder", "radius": 20, "height": 30 },
      "children": [
        {
          "name": "link1",
          "type": "transform",
          "pose": {
            "position": [0, 0, 30],
            "orientation": [0, 0, 0, 1]
          },
          "model": { "type": "cube", "size": [40, 40, 100] },
          "children": []
        }
      ]
    }
  ]
}
```

---

## Протокол обновления координат

Для обновления положения подвижных сочленений в реальном времени (через MQTT или другой транспорт).

### Формат сообщения

```json
{
  "timestamp": 1234567890123,
  "joints": {
    "joint1": 1.57,
    "joint2": 0.5,
    "linear1": 150.0
  }
}
```

### Поля

- `timestamp` (number, опционально): Unix timestamp в миллисекундах
- `joints` (object): Словарь имя_сочленения → текущая_координата
  - Для `rotator`: угол в радианах
  - Для `actuator`: линейное смещение (единицы TBD)

---

## Открытые вопросы

1. **Единицы измерения** — не согласованы (мм, см, м?)
2. **Формат 3D-моделей для веба** — OBJ не поддерживается напрямую в WebGL, нужно решить:
   - Конвертировать в glTF при загрузке?
   - Использовать glTF как основной формат?
   - Поддерживать OBJ через three.js OBJLoader?
3. **Транспорт** — MQTT, но возможно изменится

---

## Источник

Формат извлечён из `TreeElement.xaml.cs`:
- Сериализация: метод `ToTrentWithChildren()` (строки 1443-1553)
- Десериализация: метод `FromTrent()` (строки 1117-1290)
